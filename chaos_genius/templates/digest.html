<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChaosGenius Alerts Digest</title>

    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://unpkg.com/simple-datatables@3.2.0/dist/style.css" rel="stylesheet" type="text/css">
</head>

<body class="bg-white">
    <div class="container mx-auto py-4">
        <h1 class="text-3xl">ChaosGenius Alerts Digest</h1>

        <div class="mt-4 flex items-center">
            <select id="alert-config-select" multiple class="grow">
            </select>

            
            <select id="email-select" multiple class="grow">
            </select>

             <div class="toggle colour flex mx-2">
                 <span>Slack alerts only:&nbsp</span><input id="slack-check" class="toggle-checkbox hidden" type="checkbox">
                <label for="slack-check" class="toggle-label inline-block w-12 h-6 rounded-full transition-color duration-150 ease-out"></label>
             </div>

            <button type="button" class="rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3" onclick="downloadCSV()">Download CSV</button>
        </div>

    <!-- Tabs -->
    <ul id="tabs" class="inline-flex pt-2 px-1 w-full border-b">
        <li class="bg-white px-4 text-gray-800 font-semibold py-2 rounded-t border-t border-r border-l -mb-px"><a id="default-tab" href="#anomaly-alerts">Anomaly Alerts</a></li>
        <li class="px-4 text-gray-800 font-semibold py-2 rounded-t"><a href="#event-alerts">Event Alerts</a></li>
    </ul>

    <div id="tab-contents">
        <div id="anomaly-alerts" class="p-4">

            <div class="m-4" style="margin-left: 2px;">
               <div class="toggle colour flex">
                   <span>Show subdimensions:&nbsp</span><input id="subdims-check" class="toggle-checkbox hidden" type="checkbox">
                  <label for="subdims-check" class="toggle-label inline-block w-12 h-6 rounded-full transition-color duration-150 ease-out"></label>
               </div>
            </div>

            <select id="kpi-select" multiple class="grow">
            </select>

            <div class="flex flex-col py-4">
                <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                    <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                        <div class="shadow overflow-hidden border-b border-gray-200 bg-gray-100 sm:rounded-2xl">
                            <table class="min-w-full divide-y divide-gray-200 table-fixed w-full" id="tasktable-anomaly">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Alert Name (ID)
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            KPI Name (ID)
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Dimension
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Value
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Expected Value
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Severity Score
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Timestamp
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Users
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="event-alerts" class="hidden p-4">
            <div class="flex flex-col py-4">
                <div class="-my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
                    <div class="py-2 align-middle inline-block min-w-full sm:px-6 lg:px-8">
                        <div class="shadow overflow-hidden border-b border-gray-200 bg-gray-100 sm:rounded-2xl">
                            <table class="min-w-full divide-y divide-gray-200" id="tasktable-event">
                                <thead class="bg-gray-900">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Triggered Alert ID
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Alert Name (ID)
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Alert Message
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Timestamp
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Channel
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider align-middle">
                                            Users
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .dataTableAnomaly-table > thead > tr > th {
            vertical-align: middle;
        }
    </style>

    <style>
        .dataTableEvent-table > thead > tr > th {
            vertical-align: middle;
        }
    </style>

    <style>
        .grow {
            flex-grow: 1;
        }
    </style>

    <style>
    .toggle-label {
      position: relative;
    }
    .toggle-label:before {
      position: absolute;
      top: 0.125rem;
      left: 0.125rem;
      display: block;
      content: "";
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 9999%;
      background-color: white;
      background-position: center;
      background-repeat: no-repeat;
      background-size: 40%;
      background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23a0aec0" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>');
      transition: transform 0.15s cubic-bezier(0, 0, 0.2, 1);
      transform: translateX(0);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .toggle-checkbox:checked + .toggle-label:before {
      transform: translateX(1.5rem);
      background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23a0aec0" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" class="feather feather-check"><polyline points="20 6 9 17 4 12"></polyline></svg>');
    }

    .toggle.slim .toggle-label:before {
      top: -0.15rem;
      left: 0;
    }
    .toggle.slim .toggle-checkbox:checked + .toggle-label:before {
      transform: translateX(1.75rem);
    }
    .toggle.colour .toggle-label {
      background-color: #feb2b2;
    }
    .toggle.colour .toggle-checkbox:checked + .toggle-label {
      background-color: #9ae6b4;
    }
    </style>

    <!-- Script for displaying anomaly alerts and event alerts -->
    <script src="https://unpkg.com/simple-datatables@3.2.0/dist/umd/simple-datatables.js" type="text/javascript"></script>
    <script>
        const dataAnomaly = [
            {% for triggered_alert in anomaly_alerts_data %}
            {% for point in triggered_alert.alert_metadata["alert_data"] %}
                [ "{{ triggered_alert.alert_name }} ({{ triggered_alert.alert_conf_id }})",
                  "{{ triggered_alert.kpi_name }} ({{ triggered_alert.kpi_id }})",
                  "{{ point['Dimension'] }}",
                  "{{ point['Value'] }}",
                  "{{ point['Expected Value'] }}",
                  `{% if point['Severity Score'] >= 65 %}
                        <span style='color:#E53935;font-weight: light' class="severity"> <span class="badge mb-3 rounded-full px-2.5 py-1 text-center object-right-top text-white text-sm mr-3 bg-red-500">!</span>
                    {% elif point['Severity Score'] >= 25 %}
                        <span style='font-weight: light' class="severity"> <span class="badge mb-3 rounded-full px-2.5 py-1 text-center object-right-top text-white text-sm mr-3 bg-yellow-500">!</span>
                    {% else %}
                        <span style='font-weight: light' class="severity"> <span class="badge mb-3 rounded-full px-2.5 py-1 text-center object-right-top text-white text-sm mr-3 bg-gray-400">!</span>
                    {% endif %}
                        {{ point['Severity Score'] }}
                    </span>`,
                  "{{ point['Time of Occurrence'] }}",
                  [
                      {% for email in (triggered_alert.alert_channel_conf or []) %}
                      "{{ email }}",
                      {% endfor %}
                  ],
                  "{{ triggered_alert.alert_channel }}",
                ],
            {% endfor %}
            {% endfor %}
        ];

        const dataTableAnomaly = new simpleDatatables.DataTable("#tasktable-anomaly", {
            data: {
                data: dataAnomaly,
            }
        });
        dataTableAnomaly.origData = dataAnomaly;
        // hide user emails and alert channel columns
        dataTableAnomaly.alertColIndex = 0;
        dataTableAnomaly.kpiColIndex = 1;
        dataTableAnomaly.emailColIndex = 7;
        dataTableAnomaly.channelColIndex = 8;
        dataTableAnomaly.columns().hide([dataTableAnomaly.emailColIndex, dataTableAnomaly.channelColIndex]);

        const dataEvent = [
            {% for triggered_alert in event_alerts_data %}
            [
                "{{ triggered_alert.id }}",
                "{{ triggered_alert.alert_name }} ({{ triggered_alert.alert_conf_id }})",
                "{{ triggered_alert.alert_message }}",
                "{{ triggered_alert.created_at }}",
                "{{ triggered_alert.alert_channel }}",
                [
                    {% for email in (triggered_alert.alert_channel_conf or []) %}
                    "{{ email }}",
                    {% endfor %}
                ],
            ],
            {% endfor %}
        ]
        const dataTableEvent = new simpleDatatables.DataTable("#tasktable-event", {
            data: {
                data: dataEvent,
            }
        });
        dataTableEvent.origData = dataEvent;
        dataTableEvent.alertColIndex = 1;
        dataTableEvent.emailColIndex = 5;
        dataTableEvent.channelColIndex = 4;
        dataTableEvent.columns().hide([dataTableEvent.emailColIndex, dataTableEvent.channelColIndex]);

        const dataTables = [dataTableAnomaly, dataTableEvent];
        let currentTable = dataTables[0];
    </script>

    <!-- Script to download CSV -->
    <script type="text/javascript">
        function downloadCSV() {
            // Variable to store the final csv data
            let csv_data = [];

            const headerRow = document.createElement("tr");
            const headers = currentTable.headings;
            for(let i = 0; i < headers.length; ++i) {
                headerRow.appendChild(headers[i].cloneNode(true));
            }

            // Get each row data
            function getRows() {
                let rows = null;
                if (currentTable.searching) {
                    const searchedRows = new Set(currentTable.searchData);
                    rows = currentTable.data.filter((_, index) => searchedRows.has(index));
                } else {
                    rows = currentTable.data;
                }

                return ([headerRow]).concat(rows);
            }

            const rows = getRows();

            for (let i = 0; i < rows.length; i++) {

                // Get each column data
                const cols = rows[i].querySelectorAll("td,th");

                // Stores each csv row data
                let csvrow = [];
                for (let j = 0; j < cols.length; j++) {
                    if (j == currentTable.emailColIndex) {
                        continue;
                    }

                    // ignore severity "!"
                    if (cols[j].lastChild && cols[j].lastChild.classList && cols[j].lastChild.classList.contains("severity")) {
                        csvrow.push(cols[j].lastChild.lastChild.textContent.trim());
                    } else {
                        // Get the text data of each cell
                        // of a row and push it to csvrow
                        csvrow.push(cols[j].innerText.trim());
                    }
                }

                // Combine each column value with comma
                csv_data.push(csvrow.join(","));
            }

            // Combine each row data with new line character
            csv_data = csv_data.join('\n');

            // Create CSV file object and feed
            // our csv_data into it
            const CSVFile = new Blob([csv_data], {
                type: "text/csv"
            });

            // Create to temporary link to initiate
            // download process
            let temp_link = document.createElement("a");

            // Download csv file
            temp_link.download = "ChaosGenius_alert_digest_export_" + (new Date()).toISOString().slice(0, 10)
 + ".csv";
            const url = window.URL.createObjectURL(CSVFile);
            temp_link.href = url;

            // This link should not be displayed
            temp_link.style.display = "none";
            document.body.appendChild(temp_link);

            // Automatically click the link to
            // trigger download
            temp_link.click();
            document.body.removeChild(temp_link);
        }
    </script>

    <script>
        let tabsContainer = document.querySelector("#tabs");

        let tabTogglers = tabsContainer.querySelectorAll("#tabs a");

        tabTogglers.forEach(function(toggler) {
          toggler.addEventListener("click", function(e) {
            e.preventDefault();

            let tabName = this.getAttribute("href");

            let tabContents = document.getElementById("tab-contents");

            for (let i = 0; i < tabContents.children.length; i++) {
              tabTogglers[i].parentElement.classList.remove("border-t", "border-r", "border-l", "-mb-px", "bg-white");
              tabContents.children[i].classList.remove("hidden");
              if ("#" + tabContents.children[i].id === tabName) {
                currentTable = dataTables[i];
                initUserEmails(currentTable);
                initAlertConfigs(currentTable);
                initKpiSelect(currentTable);
                continue;
              }
              tabContents.children[i].classList.add("hidden");
            }
            e.target.parentElement.classList.add("border-t", "border-r", "border-l", "-mb-px", "bg-white");
          });
        });

    </script>

    <!-- Subdimensional toggle button -->
    <script>
        const subdimsCheck = document.getElementById("subdims-check");

        function initSubdimsCheck() {
            let params = new URLSearchParams(location.search);

            if (params.get("subdims") == "true") {
                subdimsCheck.checked = true;
            }
        }

        initSubdimsCheck();

        subdimsCheck.addEventListener("click", () => {
            const parser = new URL(window.location);
            if (subdimsCheck.checked) {
                parser.searchParams.set("subdims", true);
            } else {
                parser.searchParams.set("subdims", false);
            }
            window.location = parser.href;
        });
    </script>
    
    <!-- Script for various filter functions -->
    <script type="text/javascript">
        const filters = new Map();

        function addFilter(name, cb) {
            filters.set(name, cb);
        }

        function removeFilter(name) {
            filters.delete(name);
        }

        function applyFilters(table) {
            let newRows = table.origData;

            for (const [filterName, cb] of filters) {
                newRows = newRows.filter(cb);
            }

            table.search("");

            table.rows().remove("all");
            // deepcopy new rows and sent to library
            // - needed since the library may modify the passed object
            table.rows().add(JSON.parse(JSON.stringify(newRows)));

            table.search(table.wrapper.querySelector(".dataTable-input").value);
        }
    </script>


    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.0.0/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.0.0/dist/js/tom-select.popular.min.js"></script>

    <!-- Script for email selection dropdown -->
    <script>
        const emailSelect = new TomSelect("#email-select", {
            items: [],
            placeholder: "Select Recipient Emails",
            plugins: {
                remove_button:{
                    title: "Remove this email",
                }
            },
        });
    </script>

    <!-- Script for alert selection dropdown-->
    <script>
        const alertSelect = new TomSelect("#alert-config-select", {
            items: ["All"],
            placeholder: "Select Alert Configurations",
            plugins: {
                remove_button:{
                    title: "Remove this alert configuration",
                }
            },
        });
    </script>

    <!-- Script for KPI selection dropdown -->
    <script>
        const kpiSelect = new TomSelect("#kpi-select", {
            items: ["All"],
            placeholder: "Select KPI Names",
            plugins: {
                remove_button:{
                    title: "Remove this KPI",
                }
            },
        });
    </script>

    <!-- Script for filtering search according to email selected-->
    <script type="text/javascript">
        function initUserEmails(currentTable) {
            const userEmails = new Set();

            currentTable.origData.forEach(datapoint => {
                datapoint[currentTable.emailColIndex].forEach(email => {
                    userEmails.add(email);
                })
            });

            emailSelect.clear(false);
            emailSelect.clearOptions();
            emailSelect.addOptions(Array.from(userEmails).map((email) => {
                console.log(email);
                return {value: email, text: email};
            }), false);
            emailSelect.refreshOptions(false);
            emailSelect.refreshItems();

            return userEmails;
        }

        let userEmails = initUserEmails(currentTable);

        const dropdown = document.getElementById("email-select");
        dropdown.addEventListener("input", () => {
            let selected = Array.from(dropdown.options).filter(option => option.selected).map(option => option.value);

            if (selected.length !== 0) {
                const selectedSet = new Set(selected);
                addFilter("email", row => {
                    const intersection = row[currentTable.emailColIndex].filter(email => selectedSet.has(email));
                    return intersection.length > 0;
                });
            } else {
                removeFilter("email");
            }

            applyFilters(currentTable);
        });
    </script>

    <!-- Script for filtering search according to alert configuration selected-->
    <script type="text/javascript">
        function initAlertConfigs(currentTable) {
            const alertConfigs = new Set();

            currentTable.origData.forEach(datapoint => {
                    alertConfigs.add(datapoint[currentTable.alertColIndex]);
            });

            alertSelect.clear(false);
            alertSelect.clearOptions();
            alertSelect.addOptions(Array.from(alertConfigs).map((alert) => {
                console.log(alert);
                return {value: alert, text: alert};
            }), false);
            alertSelect.refreshOptions(false);
            alertSelect.refreshItems();

            return alertConfigs;
        }

        let alertConfigs = initAlertConfigs(currentTable);
        const dropdownAlerts = document.getElementById("alert-config-select");
        dropdownAlerts.addEventListener("input", () => {
            const selected = Array.from(dropdownAlerts.options).filter(option => option.selected).map(option => option.value);
            const selectedSet = new Set(selected);

            if(selectedSet.size > 0){
                addFilter("alert-name", row => {
                    return selectedSet.has(row[currentTable.alertColIndex])
                });
            }
            else{
                removeFilter("alert-name");
            }

            applyFilters(currentTable);
        });
    </script>

    <!-- Script for filtering search accoring to KPI configuration selected-->
    <script type="text/javascript">
        function initKpiSelect(currentTable) {
            const kpiNames = new Set();

            currentTable.origData.forEach(datapoint => {
                kpiNames.add(datapoint[currentTable.kpiColIndex]);
            });

            kpiSelect.clear(false);
            kpiSelect.clearOptions();
            kpiSelect.addOptions(Array.from(kpiNames).map((kpi) => {
                console.log(kpi);
                return {value: kpi, text: kpi};
            }), false);
            kpiSelect.refreshOptions(false);
            kpiSelect.refreshItems();

            return kpiNames;
        }

        let kpiNames = initKpiSelect(currentTable);
        const dropdownKpi = document.getElementById("kpi-select");
        dropdownKpi.addEventListener("input", () => {
            const selected = Array.from(dropdownKpi.options).filter(option => option.selected).map(option => option.value);
            const selectedSet = new Set(selected);

            if(selectedSet.size > 0){
                addFilter("kpi-name", row => {
                    return selectedSet.has(row[currentTable.kpiColIndex])
                });
            }
            else{
                removeFilter("kpi-name");
            }

            applyFilters(currentTable);
        });
    </script>

    <!-- Script to show alerts sent using Slack as the medium-->
    <script type="text/javascript">
        document.getElementById("slack-check").addEventListener("input", (e) => {
            const checked = e.target.checked;

            if (checked) {
                addFilter("slack", row => {
                    console.log(row[currentTable.channelColIndex]);
                    return row[currentTable.channelColIndex] == "slack";
                });
            } else {
                removeFilter("slack");
            }
            applyFilters(currentTable);
        });
    </script>
</body>

</html>
